<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Streaming Multipart Viewer</title>
  <style>
    body { font-family: sans-serif; line-height: 1.5; padding: 1rem; }
    img { max-width: 400px; border: 1px solid #ccc; margin-top: 1rem; }
    pre { background: #f7f7f7; padding: 1rem; border: 1px solid #ddd; }
  </style>
</head>
<body>
  <h2>JSON Data</h2>
  <pre id="json-output">Waiting for JSON...</pre>

  <h2>Image (Streaming Preview)</h2>
  <img id="image-output" alt="Image will load progressively..." />

  <script>
    async function fetchMultipartDataProgressive() {
      const response = await fetch('http://100.118.112.252:8080/multipart-data');
      const contentType = response.headers.get('content-type');

      if (!contentType || !contentType.includes('multipart')) {
        console.error('Unexpected content type:', contentType);
        return;
      }

      const boundary = '--' + contentType.split('boundary=')[1];
      const decoder = new TextDecoder();
      const reader = response.body.getReader();

      let state = 'json';
      let buffer = '';
      let jsonParsed = false;
      let imageChunks = [];
      let imageBytesSoFar = 0;

      function updateImage() {
        const blob = new Blob(imageChunks, { type: 'image/jpeg' }); // use 'image/png' if needed
        const url = URL.createObjectURL(blob);
        document.getElementById('image-output').src = url;
      }

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        // For text-based states
        if (state !== 'stream-image') {
          const chunkText = decoder.decode(value, { stream: true });
          buffer += chunkText;

          // Inner loop allows multiple state transitions per chunk
          while (true) {
            if (state === 'json' && buffer.includes('Content-Type: application/json')) {
              const jsonStart = buffer.indexOf('\r\n\r\n') + 4;
              const jsonEnd = buffer.indexOf(boundary, jsonStart);
              const jsonStr = buffer.substring(jsonStart, jsonEnd).trim();

              try {
                const jsonData = JSON.parse(jsonStr);
                document.getElementById('json-output').textContent = JSON.stringify(jsonData, null, 2);
                buffer = buffer.slice(jsonEnd);  // trim buffer
                state = 'image-header';
                continue;
              } catch (e) {
                break;  // wait for more data
              }
            }

            if (state === 'image-header' && (buffer.includes('Content-Type: image/jpeg') || buffer.includes('Content-Type: image/png'))) {
              const headerEnd = buffer.indexOf('\r\n\r\n') + 4;
              const leftover = buffer.slice(headerEnd);

              const leftoverBytes = new TextEncoder().encode(leftover);
              imageChunks.push(leftoverBytes);
              imageBytesSoFar += leftoverBytes.length;

              buffer = '';
              state = 'stream-image';
              break;  // switch to binary mode
            }

            break;  // no more transitions possible
          }
        } 
        
        // For binary mode
        else if (state === 'stream-image') {
          imageChunks.push(value);
          imageBytesSoFar += value.length;

          if (imageBytesSoFar >= 100 * 1024) {
            updateImage();
            imageBytesSoFar = 0;
          }
        }
      }

      if (imageChunks.length > 0) updateImage();
    }

    fetchMultipartDataProgressive();
  </script>
</body>
</html>
