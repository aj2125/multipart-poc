<script>
  async function fetchMultipartDataProgressive() {
    const response = await fetch('http://100.118.112.252:8080/multipart-data');

    const contentType = response.headers.get('content-type');
    if (!contentType || !contentType.includes('multipart')) {
      console.error('Unexpected content type:', contentType);
      return;
    }

    const boundary = '--' + contentType.split('boundary=')[1];
    const decoder = new TextDecoder();
    const reader = response.body.getReader();

    let buffer = '';
    let imageChunks = [];
    let imageBytesSoFar = 0;
    let jsonShown = false;
    let collectingImage = false;

    function updateImage() {
      const blob = new Blob(imageChunks, { type: 'image/png' });
      const url = URL.createObjectURL(blob);
      document.getElementById('image-output').src = url;
    }

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      const chunkText = decoder.decode(value, { stream: true });
      buffer += chunkText;

      // Show JSON early
      if (!jsonShown && buffer.includes('application/json')) {
        const jsonStart = buffer.indexOf('\r\n\r\n') + 4;
        const jsonEnd = buffer.indexOf(boundary, jsonStart);
        const jsonStr = buffer.substring(jsonStart, jsonEnd).trim();
        try {
          const jsonData = JSON.parse(jsonStr);
          document.getElementById('json-output').textContent = JSON.stringify(jsonData, null, 2);
          jsonShown = true;
        } catch (e) {
          // not ready yet
        }
      }

      // Detect start of image
      if (!collectingImage && buffer.includes('Content-Type: image/png')) {
        collectingImage = true;
        const splitAt = buffer.indexOf('\r\n\r\n') + 4;
        const leftover = buffer.slice(splitAt);
        const leftoverBytes = new TextEncoder().encode(leftover);
        imageChunks.push(leftoverBytes);
        imageBytesSoFar += leftoverBytes.length;
        buffer = '';
        continue;
      }

      // Stream image
      if (collectingImage) {
        imageChunks.push(value);
        imageBytesSoFar += value.length;

        // Show preview every 100 KB
        if (imageBytesSoFar >= 100 * 1024) {
          updateImage();
          imageBytesSoFar = 0;
        }
      }
    }

    // Final image rendering
    if (imageChunks.length) updateImage();
  }

  fetchMultipartDataProgressive();
</script>
